# NixOSConfig (flake-based)

This repository contains my **NixOS system configuration using Flakes**, organized into small, focused modules for easier maintenance, toggling features, and debugging.

> Target host in this repo: `nixos` (used in commands like `--flake /etc/nixos#nixos`).

---

## Goals

- Reproducible NixOS setup with **flakes**
- Modular structure (`modules/*.nix`)
- Smooth desktop + terminal experience (KDE/Plasma + Kitty + Zsh)
- Easy rebuild, rollback, and cleanup (generations / boot entries)

---

## Repository Layout

Top-level files:

- `flake.nix` / `flake.lock` — flake inputs + outputs
- `configuration.nix` — main system entry / imports (or “glue” file)
- `hardware-configuration.nix` — hardware config generated by NixOS
- `modules/` — modular configuration pieces

Typical modules (names may vary):

- `base.nix` — networking, locale, timezone, core system defaults
- `common.nix` — shared settings across modules
- `packages.nix` — system packages
- `dev.nix` — developer tooling
- `shell.nix` — Zsh + prompt + autosuggestions/history/completions
- `terminal.nix` — terminal apps + config (Kitty, fonts, etc.)
- `ui.nix` — desktop UI config (KDE/Plasma, SDDM, fonts, portals…)
- `maintenance.nix` — garbage collection, generations cleanup helpers
- `user.nix` — user account settings
- `vietnamese.nix` — Vietnamese input / locale-related settings
- `desktop.nix` — optional alternative DE setup (avoid enabling multiple DE/DM stacks)

---

## Quick Start (Install to `/etc/nixos`)

### 1) Clone into `/etc/nixos`

```bash
sudo rm -rf /etc/nixos
sudo git clone https://github.com/nvtank/NixOSConfig /etc/nixos
cd /etc/nixos
```

### 2) Apply the configuration (switch)

If flakes are already enabled globally:

```bash
sudo nixos-rebuild switch --flake /etc/nixos#nixos
```

If your system does **not** have flakes enabled globally yet, use a one-shot rebuild:

```bash
sudo NIX_CONFIG="experimental-features = nix-command flakes" \
  nixos-rebuild switch --flake /etc/nixos#nixos
```

### 3) Update flake inputs

```bash
cd /etc/nixos
sudo nix flake update
sudo nixos-rebuild switch --flake .#nixos
```

---

## Useful Commands

### Show flake outputs

```bash
nix --extra-experimental-features "nix-command flakes" flake show /etc/nixos
```

### Build first (safer than switching right away)

```bash
sudo nixos-rebuild build --flake /etc/nixos#nixos
```

### Full error trace

```bash
sudo nixos-rebuild switch --flake /etc/nixos#nixos --show-trace
```

---

## Cleaning Up Boot Menu (Remove Old Generations)

NixOS creates system generations that can show up as many boot entries (systemd-boot).

### Keep only the last N generations (example: keep last 3)

```bash
sudo nix-env -p /nix/var/nix/profiles/system --list-generations
sudo nix-env -p /nix/var/nix/profiles/system --delete-generations +3
sudo nixos-rebuild boot
```

Optional: free disk space aggressively

```bash
sudo nix-collect-garbage -d
```

---

## Desktop Notes (KDE/Plasma vs GNOME)

**Important:** Do NOT enable multiple display managers at once (e.g. `gdm` + `sddm`), or rebuild will fail.

- KDE/Plasma typically uses **SDDM**
- GNOME typically uses **GDM**

If you use KDE: keep Plasma+SDDM and disable GNOME+GDM everywhere.

---

## Terminal + Shell Experience

This setup is intended to feel modern and fast:

- **Kitty** terminal (fast, themeable)
- **Zsh** shell
- Nice-to-have tools:
  - `zsh-autosuggestions` (inline command suggestions)
  - `zsh-syntax-highlighting` (syntax coloring)
  - `starship` prompt
  - `fzf` fuzzy search
  - `nix-index` + `nix-index-database` (command-not-found support with flakes)

---

## Common Issues & Fixes

### “experimental Nix feature 'nix-command' is disabled”
Use the one-shot `NIX_CONFIG=...` form, or enable flakes globally in your NixOS config.

### “Git tree '/etc/nixos' is dirty”
This is only a warning: you have uncommitted changes in `/etc/nixos`.

### Conflicting desktop / display manager
Disable one stack (either KDE/SDDM or GNOME/GDM). Don’t enable both.

---

## License

Personal configuration repo. Feel free to copy ideas, but adjust for your hardware and needs.
